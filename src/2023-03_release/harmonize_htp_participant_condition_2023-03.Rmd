---
title: "Harmonize HTP clinical data - March 2023"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(synapser)
library(readxl)
library(googlesheets4)

synLogin()
```

Read in data:

NOTE: BMI, Weight, Height have "NA" strings
OfficialDSDiagnosis has blanks (`NA`) 

```{r}
htp_clinical_source <- read_xlsx(synGet("syn25574963")$path)
```

Replace headers with working_headers
See Google sheet `INCLUDE clinical data dictionaries` -> `HTP`
```{r}
gs4_deauth()
htp_working_headers <- read_sheet(
  "https://docs.google.com/spreadsheets/d/118amKSbrLRbmHrczFPhkLsxLKFu3GEr5goPMDvrlvxw/edit#gid=0",
           sheet = "HTP")

htp_clinical_source <- setNames(htp_clinical_source, htp_working_headers$working_header)
```

Get ETL plan
```{r}
# source("harmonization_setup_2023-03.R")

htp_etl_plan <- etl_to_linkml_plan %>% 
  filter(study == "HTP")
```

Add Participant IDs: 
```{r}
htp_clinical_harmonized <- htp_clinical_source %>% 
  mutate(participantExternalId = 
           str_extract(lab_id, "HTP[:digit:]{4}"),
         .before = everything())
```


##### PARTICIPANT

Remove Condition cols & anything that changes by visit
Remove duplicate rows caused by multiple visits
```{r}
htp_participant <- htp_clinical_harmonized %>% 
  select(participantExternalId, sex_original, age_at_enrollment_days, family_id, karyotype, relationship, ds_diagnosis, race_original, ethnicity_original, official_ds_diagnosis) %>% 
  distinct()
```


Sex: No changes needed

Race:
```{r}
lookup_values <- htp_etl_plan %>% 
  filter(model_slot == "race") %>% 
  select(model_enum_label, original_value) %>% 
  unnest(original_value)

htp_participant <- htp_participant %>% 
  left_join(lookup_values, by = c("race_original" = "original_value")) %>% 
  rename(race = model_enum_label)

# check:
# htp_participant %>% select(participantExternalId, race_original, race)
```

Ethnicity:
```{r}
lookup_values <- htp_etl_plan %>% 
  filter(model_slot == "ethnicity") %>% 
  select(model_enum_label, original_value) %>% 
  unnest(original_value)

htp_participant <- htp_participant %>% 
  left_join(lookup_values, by = c("ethnicity_original" = "original_value")) %>% 
  rename(ethnicity = model_enum_label)

# check:
# htp_participant %>% select(participantExternalId, ethnicity_original, ethnicity)
```

Down Syndrome Status:
```{r}
lookup_values <- htp_etl_plan %>% 
  filter(model_slot == "downSyndromeStatus") %>% 
  select(model_enum_label, original_value) %>% 
  unnest(original_value)

htp_participant <- htp_participant %>% 
  left_join(lookup_values, by = c("karyotype" = "original_value")) %>% 
  rename(downSyndromeStatus = model_enum_label) 

# check:
# htp_participant %>% select(participantExternalId, karyotype, downSyndromeStatus)
```

Family ID: No changes needed

Family Relationship:
(Note: "of control" means "of D21" - NOT unrelated
Currently only classifying relationships to Proband, not within Unrelated Control families)

```{r}
htp_participant <- htp_participant %>% 
  separate_rows(relationship, sep = ",") %>% 
  mutate(relationship = str_trim(relationship)) %>% 
  filter(!str_detect(relationship, "of Control")) %>% 
  mutate(familyRelationship = case_when(
    relationship == "Control - No relation to proband" ~ "Unrelated control",
    relationship == "Proband" ~ "Proband",
    relationship == "Sibling of Proband" ~ "Sibling",
    relationship == "Other relation of Proband" ~ "Other relative",
    relationship == "Parent of Proband" & sex_original == "Male" ~ "Father",
    relationship == "Parent of Proband" & sex_original == "Female" ~ "Mother"
  ))

# htp_participant %>% select(participantExternalId, family_id, sex_original, relationship, familyRelationship) 

```

Find participants who have more than 1 relationship listed

## also fix these below for Family Type and Family IDs

```{r}

htp_participant %>% 
  select(participantExternalId, family_id, sex_original, relationship, familyRelationship) %>% 
  group_by(participantExternalId) %>% 
  mutate(n = n()) %>% 
  arrange(desc(n)) %>% 
  filter(n >= 2)

```

Family Type:
**DO WE NEED DUO+ OR PROBAND+SIBLING?**
```{r}
# figure out Family Types first for each family
family_types <- htp_participant %>% 
  select(participantExternalId, family_id, familyRelationship) %>% 
  arrange(family_id) %>% 
  distinct() %>% 
  add_count(family_id) %>%
  group_by(family_id) %>% 
  mutate(familyType = case_when(
    n == 1 & familyRelationship == "Proband" ~ "Proband-only",
    n == 1 & familyRelationship == "Other relative" ~ "Other",
    n >= 1 & any(familyRelationship == "Unrelated control") ~ "Control-only",
    n == 2 & any(str_detect(familyRelationship, "Mother|Father")) ~ "Duo",
    n == 3 & all(!str_detect(familyRelationship, "Sibling|Other relative")) ~ "Trio",
    n > 3 & any(familyRelationship == "Proband") & any(familyRelationship == "Mother") & any(familyRelationship == "Father") ~ "Trio+",
    TRUE ~ "Other"
 )) %>% 
  select(family_id, familyType) %>% 
  distinct() 

htp_participant <- htp_participant %>% 
  left_join(family_types, by = "family_id")

# htp_participant %>% arrange(family_id) %>% select(participantExternalId, family_id, sex_original, relationship, familyRelationship, familyType) 
```

Family Member IDs:
```{r}
# mother & father IDs
parent_ids <- htp_participant %>%
  arrange(family_id) %>% 
  select(participantExternalId, family_id, familyRelationship) %>%
  filter(str_detect(familyRelationship, "Proband|Mother|Father")) %>% 
  pivot_wider(id_cols = family_id,
              names_from = familyRelationship,
              values_from = participantExternalId) %>% 
  unnest() %>% 
  rename(participantExternalId = Proband,
         motherId = Mother,
         fatherId = Father)

# sibling IDs
sibling_ids <- htp_participant %>%
  arrange(family_id) %>% 
  select(participantExternalId, family_id, familyRelationship) %>%
  filter(str_detect(familyRelationship, "Proband|Sibling")) %>% 
  pivot_wider(id_cols = family_id,
              names_from = familyRelationship,
              values_from = participantExternalId) %>% 
  unnest_wider(Sibling, names_sep = "") %>% 
  unnest(Proband) %>% 
  unite(col = "siblingId", starts_with("Sibling"), sep = ", ", na.rm = TRUE) %>%
  filter(siblingId != "") %>% 
  rename(participantExternalId = Proband)

# other relative IDs
other_rel_ids <- htp_participant %>%
  arrange(family_id) %>% 
  select(participantExternalId, family_id, familyRelationship) %>%
  filter(str_detect(familyRelationship, "Proband|Other")) %>% 
  pivot_wider(id_cols = family_id,
              names_from = familyRelationship,
              values_from = participantExternalId) %>% 
  unnest_wider(`Other relative`, names_sep = "") %>% 
  unnest(Proband) %>% 
  unite(col = "otherFamilyMemberId", starts_with("Other"), sep = ", ", na.rm = TRUE) %>% 
  filter(otherFamilyMemberId != "") %>% 
  rename(participantExternalId = Proband)

htp_participant <- htp_participant %>% 
  left_join(parent_ids) %>% 
  left_join(sibling_ids) %>% 
  left_join(other_rel_ids) 

# htp_participant %>% select(participantExternalId, family_id, familyType, familyRelationship, motherId, fatherId, siblingId, otherFamilyMemberId) %>% arrange(family_id)

```


Create final Participant table:

- Fill in info that is same for every participant
- Rename columns that need renamed with schema labels 
- select all Participant columns
- rename with display names

```{r}
htp_participant <- htp_participant %>% 
  mutate(studyCode = "HTP",
         participantGlobalId = NA,
         familyId = family_id,
         sex = sex_original,
         ageAtFirstPatientEngagement = age_at_enrollment_days,
         firstPatientEngagementEvent = "Enrollment",
         outcomesVitalStatus = NA,
         ageAtLastVitalStatus = NA) %>% 
  select(all_of(participant_schemalabels)) %>% 
  setNames(participant_displaynames)
```

```{r}
write_csv(htp_participant, here::here("output", "htp_participant.csv"))
```


##### CONDITION

Get HTP conditions & measures
```{r}
condition_lookup_htp <- condition_codes_v3 %>% filter(study == "HTP")
measure_lookup_htp <- measure_codes_v3 %>% filter(study == "HTP")
```

Data Check: confirm that every set of visits for a participant has the same phenotype values (i.e. 1)
```{r}
htp_clinical_harmonized %>% 
  select(-(lab_id:mr_abstraction_status)) %>% 
  group_by(participantExternalId) %>% 
  distinct() %>% 
  count() %>% 
  arrange(desc(n))

test <- htp_clinical_harmonized %>% 
  filter(participantExternalId == "HTP0332") %>% 
  select(-(participantExternalId:mr_abstraction_status))

test[1,] == test[2,]
```

Pull conditions from clinical data
** SPECIAL CASE: Delete column "Anatomical Anomaly" and all "Unsure" cols, per Angela
```{r}
htp_conditions_subset <- htp_clinical_harmonized %>% 
  select(-(lab_id:mr_abstraction_status), -`Anatomical anomaly`, -starts_with("Unsure")) %>%
  group_by(participantExternalId) %>% 
  distinct() %>% 
  ungroup() %>% 
  pivot_longer(cols = c(-participantExternalId), 
               names_to = "source_text",
               values_to = "status") %>%
  filter(status == TRUE) %>% 
  left_join(condition_lookup_htp, by = c("source_text" = "source_column")) %>% 
  select(-study, -source_column_value)
```

Add DS Diagnosis (T21 participants only)

```{r}
htp_ds_diagnoses <- htp_clinical_harmonized %>% 
  select(participantExternalId,
         source_text = official_ds_diagnosis) %>% 
  filter(!is.na(source_text)) %>% 
  distinct() %>%
  mutate(status = "TRUE") %>% 
  left_join(condition_lookup_htp %>% filter(source_column == "official_ds_diagnosis"),
            by = c("source_text" = "source_column_value")) %>% 
  select(-study, -source_column)
```

Combine conditions + ds_diagnoses
Create empty/all same value columns
Select columns in order of DCA template
```{r}
htp_conditions <- htp_ds_diagnoses %>% 
  rbind(htp_conditions_subset) %>% 
  arrange(participantExternalId) %>% 
  mutate(eventId = NA,
         eventType = NA,
         ageAtConditionMeasureObservation = NA,
         conditionInterpretation = "Observed",
         conditionStatus = "History Of",
         conditionDataSource = "Clinical",
         measureValue = NA,
         measureUnit = NA) %>%
  select(all_of(condition_schemalabels))

```

Measures:
```{r}
htp_measures <- htp_clinical_harmonized %>% 
  select(participantExternalId, event_name, bmi, weight_kg, height_cm, age_at_visit_days) %>% 
  pivot_longer(cols = c(bmi, weight_kg, height_cm),
               names_to = "source_text",
               values_to = "measureValue") %>% 
  left_join(measure_lookup_htp %>% filter(study == "HTP"),
            by = c("source_text" = "source_column")) %>% 
  mutate(eventId = event_name,
         eventType = "Visit",
         ageAtConditionMeasureObservation = age_at_visit_days,
         conditionInterpretation = NA,
         conditionStatus = NA, conditionDataSource = NA,
         hpoLabel = NA,
         hpoCode = NA,
         mondoLabel = NA,
         mondoCode = NA,
         maxoLabel = NA,
         maxoCode = NA
         ) %>% 
  select(all_of(condition_schemalabels))
```


Join conditions & measures, rename with display names

```{r}
htp_condition <- htp_conditions %>% 
  rbind(htp_measures) %>% 
  arrange(participantExternalId, eventId) %>% 
  setNames(condition_displaynames)
```


```{r}
write_csv(htp_condition, here::here("output", "htp_condition.csv"))
```
