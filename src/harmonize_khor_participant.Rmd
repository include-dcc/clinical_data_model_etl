---
title: "Harmonize Khor demographic data to portal schema"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(synapser)
library(readxl)

synLogin()
```


Read in data:
```{r}
khor_demographic_data <- read_xlsx(synGet("syn32937504")$path)
```


## PARTICIPANT

Participant ID = External ID = BRI INCLUDE ID
```{r}
khor_transformed <- khor_demographic_data %>% 
  rename(`External ID` = `BRI INCLUDE ID`)
```

Columns that need to be transformed:

Sex = needs initial cap
Race
- White, Caucasian = White
- Black, African American = Black or African American
- American Indian, Alaska Native = American Indian or Alaska Native
- Do Not Know = Unknown
- NA = Unknown
- Other Race = Other
- everything with comma = More than one race
Ethnicity

```{r}
khor_transformed <- khor_transformed %>% 
  mutate(Gender = str_to_title(Gender)) %>% 
  mutate(Race = str_replace(Race, "White, Caucasian", "White"),
         Race = str_replace(Race, "Black, African American", "Black or African American"),
         Race = str_replace(Race, "American Indian, Alaska Native", "American Indian or Alaska Native"),
         Race = str_replace(Race, "Do Not Know", "Unknown"),
         Race = str_replace(Race, "Other Race", "Other")) %>% 
  mutate(Race = case_when(is.na(Race) ~ "Unknown",
                          str_detect(Race, ",") ~ "More than one race",
                          TRUE ~ Race)) %>% 
  rename(Ethnicity = `Ethnicity (hispanic/latino y/n)`) %>% 
  mutate(Ethnicity = case_when(
    Ethnicity == "yes" ~ "Hispanic or Latino",
    Ethnicity == "no" ~ "Not Hispanic or Latino",
    Ethnicity == "decline" ~ "Prefer not to answer",
    is.na(Ethnicity) ~ "Unknown"))
```


Final table:

- Rename/create the remaining empty cols needed to match DCA template
- Then select cols in order 

*** Use "Not provided" for empty columns where other datasets (e.g. HTP) have data - otherwise schematic ({pandas}) interprets cols with only "NA" as Double

```{r}
khor_participant <- khor_transformed %>% 
  mutate(`Study Code` = "DS-Immune",
         `Participant ID` = `External ID`,
         `Family ID` = "Not provided",
         `Family Type` = "Proband-only",
         `Father ID` = "Not provided",
         `Mother ID` = "Not provided",
         `Family Relationship` = "Not provided",
         `Down Syndrome Status` = "T21",
         `Outcomes Vital Status` = "Not provided",
         `Age at Last Vital Status` = "Not provided") %>% 
  select(`Study Code`,
         `Participant ID`,
         `External ID`,
         `Family ID`,
         `Family Type`,
         `Father ID`,
         `Mother ID`,
         `Family Relationship`,
         Sex = Gender,
         Race,
         Ethnicity,
         `Down Syndrome Status`,
         `Outcomes Vital Status`,
         `Age at Last Vital Status`)

```


```{r}
write_csv(khor_participant, here::here("output", "khor_participant.csv"))
```















