---
title: "Harmonize HTP clinical data"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(synapser)
library(readxl)

synLogin()
```

Read in data:

```{r}
htp_clinical_data <- read_csv(synGet("syn25574963")$path)
```

##### PARTICIPANT

Participant Study Code = "HTP"

```{r}
htp_clinical_transformed <- htp_clinical_data %>% 
  mutate(`External ID` = 
           str_extract(LabID, "HTP[:digit:]{4}"),
         .before = everything()) %>% 
  mutate(`Study Code` = "HTP", .before = everything())
```

Family ID - as is

Family Type - we don't have this info for HTP - in portal it just says "other" Father ID - blank in portal Mother ID - blank in portal Family Relationship - in portal it just says "family member" even for probands

Sex = as is

Race - remove hyphen from "African American" - replace blank (NA) with "Unknown"

```{r}
unique(htp_clinical_data$Race)

#Note that the NAs in the HTP data are strings, not `NA`
htp_clinical_transformed <- htp_clinical_transformed %>% 
  mutate(Race = str_replace(Race, "Black or African-American", "Black or African American"),
         Race = replace_na(Race, "Unknown")
  )
```

Ethnicity

```{r}
unique(htp_clinical_data$Ethnicity)

htp_clinical_transformed <- htp_clinical_transformed %>% 
  mutate(Ethnicity = case_when(
    Ethnicity == "Hispanic / Latino" ~ "Hispanic or Latino",
    Ethnicity == "Not Hispanic / Latino" ~ "Not Hispanic or Latino",
    Ethnicity == "Unsure" ~ "Unknown",
    is.na(Ethnicity) ~ "Unknown",
    TRUE ~ Ethnicity
  ))
```

Down Syndrome Status

```{r}
unique(htp_clinical_data$Cohort_type)

htp_clinical_transformed <- htp_clinical_transformed %>% 
  mutate(`Down Syndrome Status` = case_when(
    Cohort_type == "Down syndrome" ~ "T21",
    Cohort_type == "Control" ~ "D21"),
    .after = Cohort_type)
```

Outcomes Vital Status - N/A Age at the Last Vital Status (Days) - N/A

Create final Participant table - Rename/create empty cols to match DCA template, has to be in order - For empty columns, replace NA with "Not provided"

```{r}
htp_participant <- htp_clinical_transformed %>% 
  mutate(`Participant ID` = `External ID`,
         `Family Type` = "Other",
         `Father ID` = "Not provided",
         `Mother ID` = "Not provided",
         `Family Relationship` = "Not provided",
         `Outcomes Vital Status` = "Not provided",
         `Age at Last Vital Status` = "Not provided") %>% 
  select(`Study Code`,
         `Participant ID`,
         `External ID`,
         `Family ID` = FamilyID,
         `Family Type`,
         `Father ID`,
         `Mother ID`,
         `Family Relationship`,
         Sex,
         Race,
         Ethnicity,
         `Down Syndrome Status`,
         `Outcomes Vital Status`,
         `Age at Last Vital Status`)

```

```{r}
write_csv(htp_participant, here::here("output", "htp_participant.csv"))
```


##### CONDITION

New table! Columns: 
Participant ID 
Condition Description 
Age at Condition Observation (Days) - blank for now 
Condition Interpretation - all "Observed" for now (ie. only positive assertions) 
Condition Source - all "Clinical" 
HPO Label 
HPO Code 
MONDO Label 
MONDO Code 
MAXO Label 
MAXO Code 
Other Label 
Other Code

```{r}
# test: confirm that every set of visits for a participant has the same phenotype values (i.e. 1)
htp_clinical_transformed %>% 
  select(-`Study Code`, -(LabID:MRAbstractionStatus)) %>% 
  group_by(`External ID`) %>% 
  distinct() %>% 
  count() %>% 
  arrange(desc(n))
```


Pull conditions from clinical data:
```{r}
htp_conditions_subset <- htp_clinical_transformed %>% 
  select(-(LabID:MRAbstractionStatus)) %>% 
  group_by(`External ID`) %>% 
  distinct() %>% 
  ungroup() %>% 
  pivot_longer(cols = c(-`Study Code`, -`External ID`), 
               names_to = "Condition Description",
               values_to = "Status") %>%
  filter(Status == TRUE)
```

Bring in previously annotated phenotypes csv downloaded from ETL Google sheet (https://docs.google.com/spreadsheets/d/1cHSburUDg6CR4az5FZR82FI992h7cyv-22pLVTFLZvE/edit#gid=1006243162)

```{r}
pheno_lookup <- read_csv(here::here("data", "pheno_codes_v2.csv")) %>% 
  filter(cohort == "HTP")
```

Add annotations from lookup table
Create empty/all same value columns
Select columns in order of DCA template
```{r}
htp_condition <- htp_conditions_subset %>% 
  left_join(pheno_lookup, by = c("Condition Description" = "source_column")) %>% 
  mutate(`Participant ID` = `External ID`,
         `Age at Condition Observation` = "Not provided",
         `Condition Interpretation` = "Observed",
         `Condition Source` = "Clinical") %>% 
  select(`Study Code`,
         `Participant ID`,
         `Condition Description`,
         `Age at Condition Observation`,
         `Condition Interpretation`,
         `Condition Source`,
         `HPO Label` = HPO_label,
         `HPO Code` = HPO_code,
         `MONDO Label` = MONDO_label,
         `MONDO Code` = MONDO_code,
         `MAXO Label` = MAXO_label,
         `MAXO Code` = MAXO_code,
         `Other Label` = Other_label,
         `Other Code` = Other_code)
```

```{r}
write_csv(htp_condition, here::here("output", "htp_condition.csv"))
```
