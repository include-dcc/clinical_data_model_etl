---
title: "Harmonize DSC clinical data"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(synapser)
library(readxl)

synLogin()
```

Read in data
```{r}
dsc_demographic <- read_csv(synGet("syn26445516")$path)
dsc_ihq <- read_csv(synGet("syn26445517")$path)
```

data checks
```{r}
# both sets have 3347 unique patients
n_distinct(dsc_demographic$patient_id)
n_distinct(dsc_ihq$patient_id)

# why are there 3348 rows in dsc_demo?
# pt 5458 has 2 identical rows in demo and ihq 
dsc_demographic %>% group_by(patient_id) %>% count() %>% arrange(desc(n))
dsc_ihq %>% group_by(session_id) %>% count() %>% arrange(desc(n))

# confirm identical
dsc_demographic %>% filter(patient_id == 5458) %>% distinct()
dsc_ihq %>% filter(session_id == 6878) %>% distinct()

# take distinct rows from the 2 datasets
dsc_demographic <- dsc_demographic %>% distinct()
dsc_ihq <- dsc_ihq %>% distinct()

```

##### PARTICIPANT

Family ID = parent_id if exists, otherwise = patient_id
Bring in parent_id from ihq
```{r}
dsc_demo_transformed <- dsc_demographic %>% 
  left_join(dsc_ihq %>% select(patient_id, parent_id) %>% distinct()) %>% 
  relocate(parent_id, .after = patient_id) %>% 
  mutate(family_id = ifelse(!is.na(parent_id), parent_id, patient_id),
         .after = parent_id) 
```
Other cols that need to be transformed: 

Family Type:
"Proband-only" if 1 unique patient_id/family_id combo
"Other" if >1 patient_id/family_id
** may want to add "Siblings" to Family Type in schema

```{r}
dsc_demo_transformed <- dsc_demo_transformed %>% 
  group_by(family_id) %>% 
  mutate(n = n(), .after = family_id) %>% 
  mutate(family_type = case_when(n == 1 ~ "Proband-only",
                                 n == 2 ~ "Other"), .after = n) %>% 
  ungroup()
```

Race:
- A couple of participants (4068 & 6181) chose all the options including Unknown -> assume they are "more than one race"
- Not specifying the different races (if >1) for now - maybe in a future release
- "Prefer not to answer" if all race columns are blank
```{r}
dsc_race <- dsc_demo_transformed %>% 
  select(patient_id, starts_with("race")) %>% 
  pivot_longer(cols = -patient_id,
               names_to = "race_col",
               values_to = "status") %>%
  filter(status == 1) %>% 
  group_by(patient_id) %>%
  mutate(n = n()) %>% 
  arrange(desc(n)) %>%
  ungroup() %>% 
  mutate(race = case_when(n > 1 ~ "More than one race",
                          n == 1 ~ str_extract(race_col, "(?<=_).*$"))) %>% 
  mutate(race = case_when(race == "white" ~ "White",
                          race == "black" ~ "Black or African American",
                          race == "asian" ~ "Asian",
                          race == "pacific_islander" ~ "Native Hawaiian or Other Pacific Islander",
                          race == "american_indian" ~ "American Indian or Alaska Native",
                          race == "unknown" ~ "Unknown",
                          TRUE ~ race)) %>% 
  select(patient_id, race) %>% 
  distinct()

# join with main Demographic table
# and replace "NA" with "Prefer not to answer"
dsc_demo_transformed <- dsc_demo_transformed %>% 
  left_join(dsc_race) %>% 
  mutate(race = replace_na(race, "Prefer not to answer"))
```

Ethnicity - replace NA with Prefer not to answer

```{r}
dsc_demo_transformed <- dsc_demo_transformed %>% 
  mutate(ethnicity = replace_na(ethnicity, "Prefer not to answer"))
```

Down Syndrome Status - all participants have DS

Outcomes Vital Status - it's in IHQ but leave out for now until filtering rules are determined



Create final Participant table - Rename/create empty cols to match DCA template, has to be in order - For empty columns, replace NA with "Not provided"

Finally, take only distinct Participant ID (filter out multiple visits)

```{r}
dsc_participant <- dsc_demo_transformed %>% 
  mutate(`Study Code` = "DSC",
         `Father ID` = "Not provided",
         `Mother ID` = "Not provided",
         `Family Relationship` = "Not provided",
         `Down Syndrome Status` = "T21",
         `Outcomes Vital Status` = "TBD",
         `Age at Last Vital Status` = "Not provided") %>% 
  select(`Study Code`,
         `Participant ID` = patient_id,
         `External ID` = patient_id,
         `Family ID` = family_id,
         `Family Type` = family_type,
         `Father ID`,
         `Mother ID`,
         `Family Relationship`,
         Sex = gender,
         Race = race,
         Ethnicity = ethnicity,
         `Down Syndrome Status`,
         `Outcomes Vital Status`,
         `Age at Last Vital Status`)
```

```{r}
write_csv(dsc_participant, here::here("output", "dsc_participant.csv"))
```


##### CONDITION

Columns: 
Participant ID 
Condition Description 
Age at Condition Observation (Days) - blank for now 
Condition Interpretation - all "Observed" for now (ie. only positive assertions) 
Condition Source - all "Clinical" 
HPO Label 
HPO Code 
MONDO Label 
MONDO Code 
MAXO Label 
MAXO Code 
Other Label 
Other Code


Bring in previously annotated phenotypes csv downloaded from ETL Google sheet (https://docs.google.com/spreadsheets/d/1cHSburUDg6CR4az5FZR82FI992h7cyv-22pLVTFLZvE/edit#gid=1006243162)

```{r}
pheno_lookup_dsc <- read_csv(here::here("data", "pheno_codes_v2.csv")) %>% 
  filter(cohort == "DSC")
```

Special cols (ie. NOT 1)
leukemia_ever_diagnosis
dementia_ad_cognitive_ever_diagnosis
dementia_ad_cognitive_ever_diagnosis
dementia_ad_cognitive_ever_diagnosis
celiac_ever_diagnosis -> gi_condition_celiac
chd_ever_diagnosis -> chd_condition_
skeletal_ever_diagnosis -> skeletal_condition_
thyroid_ever_diagnosis -> thyroid_condition_
seizures_epilepsy_ever_diagnosis
gi_ever_diagnosis -> gi_condition_
sleep_ever_diagnosis -> sleep_condition_
covid19_ever_diagnosis
diabetes_ever_diagnosis
eye_exam_ever
hearing_testing_ever
ds_specific_diagnosis

Check CHD cols

*** WAITING until I know how to filter the data
```{r}
# patients where chd_ever = Yes but doesn't have other chd_conditions: 17
# https://stackoverflow.com/a/62162600
dsc_ihq %>% 
  select(patient_id, chd_ever_diagnosis, starts_with("chd_condition_"), -chd_condition_none) %>% 
  rowwise() %>% 
  filter(chd_ever_diagnosis == "Yes" & 
           all(is.na(c_across(starts_with("chd_condition")))))

# patients where chd_ever = No but has other chd_conditions? 
dsc_ihq %>% 
  select(patient_id, chd_ever_diagnosis, starts_with("chd_condition_"), -chd_condition_none) %>% 
  rowwise() %>% 
  filter(chd_ever_diagnosis == "No" & 
           any(!is.na(c_across(starts_with("chd_condition")))))

# or patients where chd_ever = Yes but chd_condition_none = No
dsc_ihq %>% 
  filter(chd_ever_diagnosis == "Yes" & chd_condition_none == 1) %>% 
  pull(patient_id)

```

Check GI cols
```{r}
# are there any patients where gi_ever = Yes but doesn't have other gi_conditions? 37
dsc_ihq %>% 
  select(patient_id, gi_ever_diagnosis, starts_with("gi_condition_"), -gi_condition_none) %>% 
  rowwise() %>% 
  filter(gi_ever_diagnosis == "Yes" & 
           all(is.na(c_across(starts_with("gi_condition")))))

# or patients where chd_ever = No but has other chd_conditions? 
dsc_ihq %>% 
  select(patient_id, chd_ever_diagnosis, starts_with("chd_condition_"), -chd_condition_none) %>% 
  rowwise() %>% 
  filter(chd_ever_diagnosis == "No" & 
           any(!is.na(c_across(starts_with("chd_condition")))))

# or patients where chd_ever = Yes but chd_condition_none = No
dsc_ihq %>% 
  filter(chd_ever_diagnosis == "Yes" & chd_condition_none == 1) %>% 
  pull(patient_id)

```


Pull conditions from clinical data
** SPECIAL CASE: Delete column "Anatomical Anomaly" and all "Unsure" cols, per Angela
Look up annotations
```{r}
htp_conditions_subset <- htp_clinical_transformed %>% 
  select(-(LabID:MRAbstractionStatus), -`Anatomical anomaly`, -starts_with("Unsure")) %>%
  group_by(`External ID`) %>% 
  distinct() %>% 
  ungroup() %>% 
  pivot_longer(cols = c(-`Study Code`, -`External ID`), 
               names_to = "Source Text",
               values_to = "Status") %>%
  filter(Status == TRUE) %>% 
  left_join(pheno_lookup_htp, by = c("Source Text" = "source_column")) %>% 
  select(-cohort, -source_column_value)

```

Add DS Diagnosis (T21 participants only)
** SPECIAL CASE: a few participants are T21 but have DS Diagnosis `NA` due to an error - per Angela, change these to "Unsure"
Look up annotations

```{r}
htp_ds_diagnoses <- htp_clinical_transformed %>% 
  mutate(OfficialDSDiagnosis = ifelse(LabID %in% c("HTP0552A", "HTP0562A", "HTP0568A", "HTP0580A", "HTP0634A", "HTP0639A", "HTP0697A"), "Unsure", OfficialDSDiagnosis)) %>% 
  filter(`Down Syndrome Status` == "T21") %>% 
  select(`Study Code`, `External ID`,
         `Source Text` = OfficialDSDiagnosis) %>% 
  mutate(Status = TRUE) %>% 
  distinct() %>% 
  left_join(pheno_lookup_htp, by = c("Source Text" = "source_column_value")) %>% 
  select(-cohort, -source_column)
```


Combine conditions + ds_diagnoses
Create empty/all same value columns
Select columns in order of DCA template
```{r}
htp_condition <- htp_ds_diagnoses %>% 
  rbind(htp_conditions_subset) %>% 
  arrange(`External ID`) %>% 
  mutate(`Participant ID` = `External ID`,
         `Age at Condition Observation` = "Not provided",
         `Condition Interpretation` = "Observed",
         `Condition Source` = "Clinical") %>% 
  select(`Study Code`,
         `Participant ID`,
         `Condition Description` = display_text,
         `Age at Condition Observation`,
         `Condition Interpretation`,
         `Condition Source`,
         `HPO Label` = HPO_label,
         `HPO Code` = HPO_code,
         `MONDO Label` = MONDO_label,
         `MONDO Code` = MONDO_code,
         `MAXO Label` = MAXO_label,
         `MAXO Code` = MAXO_code,
         `Other Label` = Other_label,
         `Other Code` = Other_code)
```

```{r}
write_csv(htp_condition, here::here("output", "htp_condition.csv"))
```
