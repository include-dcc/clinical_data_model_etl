---
title: "HTP VBR biospecimen manifest for v4"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(synapser)
library(readxl)
library(googlesheets4)

synLogin()
```


## CHECKS

Get VBR files

```{r}
vbr_biospecimens <- read_delim(synGet("syn52138216")$path, "\t")
vbr_participants <- read_delim(synGet("syn52138217")$path, "\t")

all_cohorts_participant <- read_csv(synGet("syn51216460")$path)
htp_participants_v3 <- all_cohorts_participant %>% filter(`Study Code` == "HTP")

portal_dump <- read_delim(synGet("syn52290446")$path, "\t")

```

Get list of dewrangle Global IDs
```{r}
htp_dewrangle_specimens <- read_csv(here::here("data", "global-descriptors-htp_2023-07-24.csv")) %>% 
  filter(fhir_resource_type == "Specimen")
```

check for dupes
```{r}
vbr_biospecimens %>% count(ContainerID) %>% arrange(desc(n))
# no dupes except for NA

vbr_biospecimens %>% select(-HTP_comment) %>% distinct() %>% count(ContainerID) %>% arrange(desc(n))

```


```{r}
# 13285 samples in vbr data not in dewrangle -> due to naming changes?
length(setdiff(unique(vbr_biospecimens$SampleID), htp_dewrangle$descriptor))

# 5430 samples in dewrangle not in vbr data -> due to naming changes?
length(setdiff(htp_dewrangle$descriptor, vbr_biospecimens$SampleID))
```

Compare biospecimen vs clinical datasets

```{r}
# all Biospecimens have Participant data
setdiff(vbr_biospecimens$ParticipantExternalID, vbr_participants$ParticipantExternalID)

# 153 Participants don't have biospecimens
setdiff(vbr_participants$ParticipantExternalID, vbr_biospecimens$ParticipantExternalID)
```


## GLOBAL IDs


Mapping of old -> new global IDs and compare to previous dewrangle output

various checks:

```{r}
htp_dewrangle_specimens # 6660

n_distinct(vbr_biospecimens$Participant_global_id) #677 - includes `NA`
n_distinct(portal_dump$`Participant ID`) #676
setdiff(vbr_biospecimens$Participant_global_id, portal_dump$`Participant ID`) #NA

n_distinct(portal_dump$`Sample ID`) #5405
n_distinct(vbr_biospecimens$Sample_global_id, na.rm = TRUE) #5335

unique_globals_in_portal <- unique(portal_dump$`Sample ID`)
unique_globals_in_vbr <- unique(vbr_biospecimens$Sample_global_id) #includes NA

globals_in_portal_not_in_vbr <- setdiff(globals_in_portal, global_in_vbr) #70 in portal, not in VBR
setdiff(global_in_vbr, globals_in_portal) #NA

portal_dump %>% filter(`Sample ID` %in% portal_not_in_vbr) %>%
  distinct() %>% arrange(`Sample Type`)
# 72 WBCs, 1 DNA, 1 CD4+, 1 CD8+
# 57 WBCs were deleted bc they don't have container IDs ("created" Parent Samples)
# the 3 others are known mismatches of Container IDs -> deleted from vbr
# not sure about the new WBCs since last update??

# make sure all sample IDs only have one sampleID_old
vbr_biospecimens %>% 
  select(SampleID, SampleID_old) %>%
  filter(!is.na(SampleID_old)) %>% 
  distinct() %>% 
  group_by(SampleID) %>% #or SampleID_old
  add_count() %>% 
  filter(n>1) %>% 
  arrange(SampleID)     #or SampleID_old

# get sample IDs without globals - 9226
# all of these samples also don't have SampleID_old
sample_without_globals <- vbr_biospecimens %>%
  select(SampleID, Sample_global_id, SampleID_old) %>%
  distinct() %>%
  filter(is.na(Sample_global_id)) %>% 
  pull(SampleID)

# check if they have matches in other rows
vbr_biospecimens %>% 
  filter(!is.na(Sample_global_id)) %>% 
  filter(SampleID %in% sample_without_globals) #0

# check if they have matches in dewrangle
sample_without_globals_but_in_dewrangle <- htp_dewrangle_specimens %>% 
  filter(descriptor %in% sample_without_globals) %>% 
  pull(descriptor) #27

# all have comment "NEW samples since portal v3 WITHOUT global IDs"
vbr_biospecimens %>% 
  filter(SampleID %in% sample_without_globals_but_in_dewrangle) %>% 
  pull(HTP_comment) %>% unique()

# none of the 27 (or any of the samples without globals) are in portal dump
portal_dump %>% 
  #filter(`Sample ID` %in% sample_without_globals_but_in_dewrangle)
  filter(`Sample ID` %in% sample_without_globals)

# check if old vs new sample types match for the 27
vbr_biospecimens %>% 
    filter(SampleID %in% sample_without_globals_but_in_dewrangle) %>% 
    select(SampleID, SampleID_old, SampleType, SampleType_old)


```

NOTE: in previous version (v8 on Synapse), found 46 samples with globals 
for both Saliva and DNA_sal -> deleted from v9 so we can move on; will deal with later
```{r}
mismatched_46_sal_samples <- vbr_biospecimens_updated_participants %>% 
  left_join(htp_dewrangle_specimens %>% select(descriptor, global_id),
            by = c("SampleID" = "descriptor")) %>% 
  rename(dewrangle_globals_by_SampleID = global_id) %>% 
  filter(!is.na(dewrangle_globals_by_SampleID)) %>% 
  select(SampleID, SampleID_old, Sample_global_id, dewrangle_globals_by_SampleID) %>% 
  filter(Sample_global_id != dewrangle_globals_by_SampleID) %>% 
  distinct() %>% 
  left_join(htp_dewrangle_specimens %>% select(descriptor, global_id),
            by = c("dewrangle_globals_by_SampleID" = "global_id")) 

#%>% 
#  write_csv(here::here("output", "mismatched_46_sal_samples.csv"))

#46 samples have mismatch
# all DNA_sal

# Both HTP0087B_Saliva and HTP0087B_DNA_sal are in dewrangle and have different global IDs
# HTP0087B_Saliva	= bs-qrne3dqn9r
# HTP0087B_DNA_sal	bs-dkex39ktr6

#all in both cols are different
setdiff(mismatched_46_sal_samples$dewrangle_globals_by_SampleID, 
        mismatched_46_sal_samples$Sample_global_id) # & vice-versa

#are the Sample_global_id in dewrangle?
htp_dewrangle_specimens %>% 
  filter(global_id %in% mismatched_46_sal_samples$Sample_global_id)
  # the Sample_global_ids are associated with DNA_sal samples

htp_dewrangle_specimens %>% 
  filter(global_id %in% mismatched_46_sal_samples$dewrangle_globals_by_SampleID)
  # the dewrangle_globals are also all in dewrangle, associated with Saliva samples

# For reference, create table of dewrangle IDs
mismatched_46_sal_in_dewrangle <- htp_dewrangle_specimens %>% 
  filter(global_id %in% mismatched_46_sal_samples$dewrangle_globals_by_SampleID|
           global_id %in% mismatched_46_sal_samples$Sample_global_id) %>% 
  arrange(descriptor) %>% 
  select(-fhir_resource_type)

write_csv(mismatched_46_sal_in_dewrangle, here::here("output", "mismatched_46_sal_in_dewrangle.csv"))

# check which are in portal
setdiff(mismatched_46_sal_samples$Sample_global_id, portal_dump$`Sample ID`) #0
setdiff(mismatched_46_sal_samples$dewrangle_globals_by_SampleID, portal_dump$`Sample ID`) #46??

portal_dump %>% 
  filter(`Sample ID` %in% mismatched_46_sal_samples$dewrangle_globals_by_SampleID)
  # the Saliva samples in dewrangle are not in portal

portal_dump %>% 
  filter(`Sample ID` %in% mismatched_46_sal_samples$Sample_global_id)
  # the DNA_sal samples from dewrangle are in the portal


```


Start by updating Participant Global IDs from dewrangle
```{r}
vbr_biospecimens_updated_participants <- vbr_biospecimens %>% 
  left_join(htp_dewrangle_patients_UPDATED %>% select(descriptor, global_id),
            by = c("ParticipantExternalID" = "descriptor")) %>% 
  rename(Participant_global_id_updated = global_id)
  #filter(Participant_global_id != global_id)
```


Pull global IDs from dewrangle by SampleID and SampleID_old
```{r}
compare_vbr_dewrangle_globals <- vbr_biospecimens_updated_participants %>% 
  left_join(htp_dewrangle_specimens %>% select(descriptor, global_id),
            by = c("SampleID" = "descriptor")) %>% 
  rename(dewrangle_globals_by_SampleID = global_id) %>%
  left_join(htp_dewrangle_specimens %>% select(descriptor, global_id),
            by = c("SampleID_old" = "descriptor")) %>% 
  rename(dewrangle_globals_by_SampleIDold = global_id) %>% 
  select(SampleID, SampleID_old, Sample_global_id, 
         dewrangle_globals_by_SampleID, dewrangle_globals_by_SampleIDold) %>% 
  distinct() 

# filter(Sample_global_id != dewrangle_globals_by_SampleID) 
# filter(Sample_global_id != dewrangle_globals_by_SampleIDold)
# filter(dewrangle_globals_by_SampleID != dewrangle_globals_by_SampleIDold)
```

Checks:

```{r}
compare_vbr_dewrangle_globals %>% 
  filter(!is.na(Sample_global_id)) %>% 
  filter(is.na(dewrangle_globals_by_SampleID) & is.na(dewrangle_globals_by_SampleIDold)) %>% 
  left_join(htp_dewrangle_specimens %>% select(descriptor, global_id),
            by = c("Sample_global_id" = "global_id")) %>% 
  select(SampleID, SampleID_old, Sample_global_id, 
         dewrangle_descriptor_matching_Sample_global_id = descriptor) %>% 
  write_csv(here::here("output", "has_global_but_no_old_id_178.csv"))

# %>% pull(Sample_global_id) -> test
#portal_dump %>% filter(`Sample ID` %in% test)

# 178 samples have Sample_global_id but nothing pulled from dewrangle
# all of those globals exist in dewrangle -> just that SampleID_old was NA
# all are in Portal (under old sample ID)
# send to matt for review

compare_vbr_dewrangle_globals %>% 
  filter(is.na(Sample_global_id) & 
           (!is.na(dewrangle_globals_by_SampleID)|!is.na(dewrangle_globals_by_SampleIDold)))
# 27 Plasma samples also have only dewrangle_globals_by_SampleID, no SampleID_old


#do any samples have >1 row?
compare_vbr_dewrangle_globals %>% 
  filter(!is.na(SampleID_old)) %>% 
  janitor::get_dupes(SampleID) #0

```


Assuming the above 178 are ok - get a single final Global ID

```{r}
final_global_id_lookup <- compare_vbr_dewrangle_globals %>% 
  mutate(global_id_final = case_when(
    !is.na(Sample_global_id) ~ Sample_global_id,
    is.na(Sample_global_id) & !is.na(dewrangle_globals_by_SampleID) ~ dewrangle_globals_by_SampleID,
    is.na(Sample_global_id) & !is.na(dewrangle_globals_by_SampleIDold) ~ dewrangle_globals_by_SampleIDold
  )) %>% 
  filter(!is.na(global_id_final)) %>% 
  select(SampleID, global_id_final) %>% 
  distinct()



```


Update vbr biospecimens
```{r}
vbr_biospecimens_updated_samples <- vbr_biospecimens_updated_participants %>% 
  left_join(final_global_id_lookup, by = "SampleID")
```


CHECK: Of the samples that don't have any global IDs - they also don't have SampleID_old
-> are any of them erroneously missing SampleID_old? 
Not sure how to search for this
```{r}
no_global_ids_yet <- compare_vbr_dewrangle_globals %>% 
  mutate(global_id_final = case_when(
    !is.na(Sample_global_id) ~ Sample_global_id,
    is.na(Sample_global_id) & !is.na(dewrangle_globals_by_SampleID) ~ dewrangle_globals_by_SampleID,
    is.na(Sample_global_id) & !is.na(dewrangle_globals_by_SampleIDold) ~ dewrangle_globals_by_SampleIDold
  )) %>% 
  filter(is.na(global_id_final)) %>% 
  distinct() %>% 
  pull(SampleID)

# send filtered export to matt for review
vbr_biospecimens_updated_samples %>% 
  filter(SampleID %in% no_global_ids_yet) %>% 
  arrange(SampleID) %>% 
  write_csv(here::here("output", "for_review_no_global_ids_9199.csv"))

```


TODO: change of strategy - make sure all samples with files have Global IDs;
create new Globals for the rest of them

```{r}
all_htp_datafiles <- read_xlsx(here::here("data", "all_htp_datafiles.xlsx"))
```


```{r}
htp_datafiles %>% 
  left_join(vbr_biospecimens_updated_samples %>% 
              select(SampleID, SampleID_old, global_id_final) %>% 
              distinct()) %>%
  filter(is.na(global_id_final)) #4

```

Above 4 samples don't appear to be in vbr_biospecimens
But they are in dewrangle:
- HTP0297A6_DNA = bs-rbrtyrgb
- HTP0298A_DNA_sal = bs-gexp663mcg
- HTP0303A_DNA_sal = bs-ffckciec6f
- HTP0306A_DNA_sal = bs-tti9rwdckw


TODO: 
make sure 2021 X01 WGS and RNAseq are in all_htp_datafiles
get TCR/BCR samples from Matt/Angela as well






```{r}
vbr_dewrangle_update_input %>% write_csv(here::here("output", "vbr_dewrangle_update_input.csv"))

```



##### HARMONIZATION

**TODO:** add Participant & Sample Global IDs

Harmonize Biospecimen

**TODO:** CLean up NULL vs N/A
REMOVE DUPLICATE ROWS

```{r}
vbr_biospecimens %>% 
  select(studyCode = StudyCode,
         participantExternalId = ParticipantExternalID,
         sampleExternalId = SampleID,
         sampleType = SampleType,
         ageAtBiospecimenCollection = AgeInDaysAtBiospecimenCollection,
         parentSampleExternalId = ParentSampleID,
         parentSampleType = ParentSampleType,
         collectionExternalId = CollectionID,
         collectionSampleType = CollectionSampleType,
         containerExternalId = ContainerID,
         volume = Volume,
         volumeUnit = VolumeUnit,
         laboratoryProcedure = LaboratoryProcedure,
         biospecimenStorage = BiospecimenStorage,
         sampleAvailability = SampleAvailability,
         containerAvailability = containerAvailability) %>% 
  mutate(participantGlobalId = "TBD",
         sampleGlobalId = "TBD",
         parentSampleGlobalId = "TBD",
         collectionGlobalId = "TBD") %>% 
  write_csv(here::here("output", "vbr_biospecimens_draft_2023-08-15.csv"))

```



## OLD WORK

<!-- ## Get Unique Sample Types for enums -->

<!-- ```{r} -->
<!-- unique(c(vbr_biospecimens$SampleType,  -->
<!--          vbr_biospecimens$ParentSampleType, -->
<!--          vbr_biospecimens$CollectionSampleType)) %>% sort() -->
<!-- ``` -->

<!-- ## FIGURING OUT OLD VS NEW SAMPLE IDs -->

<!-- Get sample ID suffixes from dewrangle -->

<!-- ```{r} -->
<!-- htp_dewrangle %>%  -->
<!--   pull(descriptor) %>%  -->
<!--   str_replace("HTP.{5,7}_", "") %>%  -->
<!--   unique() -->
<!-- ``` -->

<!-- Get sample ID suffixes from VBR export -->

<!-- ```{r} -->
<!-- vbr_biospecimens %>%  -->
<!--   pull(SampleID) %>%  -->
<!--   str_replace("HTP.{5,7}_", "") %>%  -->
<!--   unique() -->
<!-- ``` -->

<!-- Read in Matt's lists of missing/unmatched samples -->

<!-- PART 1: 72 samples with --, 6 with NA or "Damaged BC"  -->
<!-- ```{r} -->
<!-- missing_containers <- read_delim(synGet("syn52293384")$path, "\t") %>%  -->
<!--   left_join(htp_dewrangle %>% select(global_id, descriptor), -->
<!--             by = c("Sample_global_id" = "global_id")) -->
<!-- ``` -->

<!-- look in aliquot.csv -->

<!-- ```{r} -->
<!-- aliquotcsv <- read_csv(synGet("syn52293019")$path) -->

<!-- aliquotcsv %>% filter(`Sample ID` %in% missing_containers$descriptor) -->
<!-- # these are all the Plasmas with NA or Damaged, so not helpful -->
<!-- ``` -->

<!-- compare v1 (htp_sample.csv) to v3 (FV_S71B1672_htp_samples_AND_COLLECTIONS_with_KF_global_ids_updated_2023-06-09.csv) -->

<!-- ```{r} -->
<!-- v1_sample_manifest <- read_csv(synGet("syn52293022")$path) #5494 -->
<!-- v3_sample_manifest <- read_csv(synGet("syn51514604")$path) #6430 -->
<!-- ``` -->
<!-- 161 samples in v1 aliquots.csv were not in v3  -->
<!-- -> Eric said 891 rows were dropped from aliquots.csv because of this -->
<!-- Per Matt, these should probably be deleted anyway, but he will check -->
<!-- ```{r} -->
<!-- #setdiff(v3_sample_manifest$`Sample External ID`, v1_sample_manifest$`Sample ID`) #1097 -->

<!-- v1_v3_setdiff <- setdiff(v1_sample_manifest$`Sample ID`, v3_sample_manifest$`Sample External ID`) #161 -->

<!-- htp_sample_manifest_robert %>%  -->
<!--   filter(`Sample ID` %in% v1_v3_setdiff) %>%  -->
<!--   write_csv(here::here("output", "v1_v3_setdiff.csv")) # sent to Matt -->
<!-- ``` -->


<!-- Look in v3 sample manifest -->
<!-- ```{r} -->
<!-- v3_sample_manifest %>% filter(`Sample External ID` %in% missing_containers$descriptor) -->

<!-- ``` -->

<!-- Look in portal dump -->
<!-- ```{r} -->
<!-- portal_dump <- read_tsv(synGet("syn52290446")$path) -->

<!-- missing_containers_that_have_files <- portal_dump %>%  -->
<!--   filter(`External Sample ID` %in% missing_containers$descriptor) %>%  -->
<!--   filter(Files != "--") %>%  -->
<!--   pull(`External Sample ID`) %>% unique() %>% sort() -->

<!-- #21 samples that don't have containers but do have files -->
<!-- ``` -->

<!-- Look in the HTP sample manifest file (Robert/Adam) -->
<!-- ```{r} -->
<!-- htp_sample_manifest_robert <- read_csv(synGet("syn48250502")$path) -->

<!-- htp_sample_manifest_robert %>%  -->
<!--   filter(`Sample ID` %in% missing_containers$descriptor) %>%  -->
<!--   pull(`Sample ID`) %>% unique() %>% sort() -->
<!-- # only the 6 Plasmas match Sample ID in Robert's sheet, and they don't have container IDs here either -->

<!-- # now look for those samples in Parent Sample column -->
<!-- htp_sample_manifest_robert %>%  -->
<!--   filter(`Parent Sample ID` %in% missing_containers$descriptor) %>% -->
<!--   pull(`Parent Sample ID`) %>% unique() -->
<!-- # 57, correct number -->
<!-- # these only appear as Parents and not Samples --> "created"? -->

<!-- ``` -->
<!-- From VBR Agenda 2023-05-30 -->

<!-- MISSING SAMPLES -->
<!-- 15 HTP samples with RNAseq in Data Service but not in portal  -->
<!-- These might have been in a small pilot - are there FASTQ files? Also public on GEO * check with Christina -->
<!-- HTP0084A2_RNA_paxgene -->
<!-- HTP0085B2_RNA_paxgene -->
<!-- HTP0204A_RNA_paxgene -->
<!-- HTP0206B_RNA_paxgene -->
<!-- HTP0288B_RNA_paxgene -->
<!-- HTP0302B_RNA_paxgene -->
<!-- HTP0310A_RNA_paxgene -->
<!-- HTP0322B_RNA_paxgene -->
<!-- HTP0326A_RNA_paxgene -->
<!-- HTP0328A_RNA_paxgene -->
<!-- HTP0332A_RNA_paxgene -->
<!-- HTP0338B_RNA_paxgene -->
<!-- HTP0348A_RNA_paxgene -->
<!-- HTP0351A_RNA_paxgene -->
<!-- HTP0442A2_RNA_paxgene -->


<!-- ```{r} -->
<!-- missing_15_samples <- c("HTP0084A2_RNA_paxgene", "HTP0085B2_RNA_paxgene", "HTP0204A_RNA_paxgene", "HTP0206B_RNA_paxgene", "HTP0288B_RNA_paxgene", "HTP0302B_RNA_paxgene", "HTP0310A_RNA_paxgene", "HTP0322B_RNA_paxgene", "HTP0326A_RNA_paxgene", "HTP0328A_RNA_paxgene", "HTP0332A_RNA_paxgene", "HTP0338B_RNA_paxgene", "HTP0348A_RNA_paxgene", "HTP0351A_RNA_paxgene", "HTP0442A2_RNA_paxgene") -->

<!-- setdiff(missing_containers_that_have_files, missing_15_samples) -->
<!-- ``` -->

<!-- PART 2: MISMATCHED CONTAINER IDs -->

<!-- ```{r} -->
<!-- unmatched_containers <- read_delim(synGet("syn52293382")$path, "\t") %>%  -->
<!--   left_join(htp_dewrangle %>% select(global_id, descriptor), -->
<!--             by = c("Sample_global_id" = "global_id")) -->
<!-- ``` -->
























