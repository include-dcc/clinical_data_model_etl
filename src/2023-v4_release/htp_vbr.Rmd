---
title: "HTP VBR v4"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(synapser)
library(readxl)
library(googlesheets4)

synLogin()
```


## CHECKS

Get VBR files

```{r}
vbr_biospecimens <- read_delim(synGet("syn52138216")$path, "\t")
vbr_participants <- read_delim(synGet("syn52138217")$path, "\t")

all_cohorts_participant <- read_csv(synGet("syn51216460")$path)
htp_participants_v3 <- all_cohorts_participant %>% filter(`Study Code` == "HTP")

portal_dump <- read_delim(synGet("syn52290446")$path, "\t")

```

Get list of dewrangle Global IDs
```{r}
htp_dewrangle_specimens <- read_csv(here::here("data", "global-descriptors-htp_2023-07-24.csv")) %>% 
  filter(fhir_resource_type == "Specimen")
```

check for dupes
```{r}
vbr_biospecimens %>% count(ContainerID) %>% arrange(desc(n))
# many duplicate rows in Biospecimen
# mostly because of two HTP_comments per container

vbr_biospecimens %>% select(-HTP_comment) %>% distinct() %>% count(ContainerID) %>% arrange(desc(n))

vbr_participants %>% count(ParticipantExternalID) %>% arrange(desc(n))
# no dupes in Participant
```


```{r}
# 13286 samples in vbr data not in dewrangle -> due to naming changes?
length(setdiff(unique(vbr_biospecimens$SampleID), htp_dewrangle$descriptor))

# 5384 samples in dewrangle not in vbr data -> due to naming changes?
length(setdiff(htp_dewrangle$descriptor, vbr_biospecimens$SampleID))
```

Compare biospecimen vs clinical datasets

```{r}
# 5 Biospecimens don't have Participant data - ???
# "HTP0429" "HTP0586" "HTP0988" "HTP0679" "HTP0691"
# all except 0988 are in v3
setdiff(vbr_biospecimens$ParticipantExternalID, vbr_participants$ParticipantExternalID)

# 65 Participants don't have biospecimens
setdiff(vbr_participants$ParticipantExternalID, vbr_biospecimens$ParticipantExternalID)
```


Compare Participants to v3 harmonized data

```{r}

# 4 participants in v3 data are in not in vbr_participants = Matt is looking for these
# "HTP0691" "HTP0679" "HTP0429" "HTP0586"
setdiff(htp_participants_v3$`Participant External ID`, vbr_participants$ParticipantExternalID)

# 267 participants in vbr_participant not in v3 data
setdiff(vbr_participants$ParticipantExternalID, htp_participants_v3$`Participant External ID`)

```

## GLOBAL IDs

Mapping of old -> new global IDs and compare to previous dewrangle output

checks:
```{r}
htp_dewrangle_specimens # 6660

n_distinct(vbr_biospecimens$Participant_global_id) #677 - includes `NA`
n_distinct(portal_dump$`Participant ID`) #676
setdiff(vbr_biospecimens$Participant_global_id, portal_dump$`Participant ID`) #NA

n_distinct(portal_dump$`Sample ID`) #5405
n_distinct(vbr_biospecimens$Sample_global_id, na.rm = TRUE) #5335

globals_in_portal <- unique(portal_dump$`Sample ID`)
global_in_vbr <- unique(vbr_biospecimens$Sample_global_id)

portal_not_in_vbr <- setdiff(globals_in_portal, global_in_vbr) #70 in portal, not in VBR
setdiff(global_in_vbr, globals_in_portal) #NA

portal_dump %>% filter(`Sample ID` %in% portal_not_in_vbr) %>% arrange(`Sample Type`)
# 57 WBCs, 1 DNA, 1 CD4+, 1 CD8+
# 57 WBCs were deleted bc they don't have container IDs ("created" Parent Samples)
# the 3 others are known mismatches of Container IDs -> deleted from vbr

vbr_biospecimens %>% 
  select(ParticipantExternalID, Participant_global_id, SampleID, SampleID_old, Sample_global_id, HTP_comment) %>% 
  mutate(sample_match = SampleID == SampleID_old) %>% 
  filter(sample_match == FALSE)
# some sampleID != sampleID_old but comment = "exact match"
# assume those are samples that Matt was able to fuzzy-match

# Only 1 sample with duplicate global IDs after Matt removed WBC Lysates
# HTP0604A4_Plasma
vbr_biospecimens %>%
  select(Sample_global_id, SampleID, SampleID_old) %>%
  distinct() %>% #get rid of multiple Container rows
  filter(!is.na(Sample_global_id)) %>% 
  group_by(Sample_global_id) %>% 
  add_count() %>%
  filter(n > 1) %>% 
  arrange(Sample_global_id)

#%>% write_csv(here::here("output", "duplicate_global_ids.csv"))

# HTP0604A4_Plasma - remove dupes later
vbr_biospecimens %>% 
  filter(SampleID == "HTP0604A4_Plasma") %>%
  select(SampleID, SampleID_old, Sample_global_id, ContainerID, ParticipantExternalID) %>% 
  arrange(ContainerID) %>% view()

# no duplication of Container IDs if you get rid of the comments and old ID cols
vbr_biospecimens %>%
  select(ParticipantExternalID:SampleAvailability) %>% 
  distinct() %>%
  filter(SampleID == "HTP0604A4_Plasma")
  filter(!is.na(ContainerID)) %>% 
  get_dupes(ContainerID)

# all the SampleIDs without Container IDs are unique
vbr_biospecimens %>%
  select(ParticipantExternalID:SampleAvailability) %>% 
  distinct() %>% 
  filter(is.na(ContainerID)) %>% 
  get_dupes(SampleID)
```


Ignore HTP_comment for now
Propagate Global IDs to Containers from Samples that already have Global & Participant IDs
```{r}
vbr_globals_updated <- vbr_biospecimens %>% 
  select(ParticipantExternalID, Participant_global_id, SampleID, SampleID_old, Sample_global_id, ContainerID) %>% 
  distinct() %>% 
  arrange(SampleID) %>% 
  group_by(ParticipantExternalID) %>% 
  mutate(participant_global_UPDATED = max(Participant_global_id, na.rm = TRUE), .after = Participant_global_id) %>% 
  ungroup() %>% 
  group_by(SampleID) %>% 
  mutate(sample_global_UPDATED = max(Sample_global_id, na.rm = TRUE), .after = Sample_global_id) %>%
  ungroup() %>% 
  select(-Participant_global_id, -Sample_global_id, -SampleID_old) %>% 
  distinct()

n_distinct(vbr_globals_updated$sample_global_UPDATED)
# 5335 (matches main vbr set)  
```

Pull in the specimen metadata columns from vbr_biospecimens
```{r}
vbr_biospecimens_updated <- vbr_globals_updated %>% 
  filter(!is.na(sample_global_UPDATED)) %>%  
  select(ContainerID, sample_global_UPDATED, participant_global_UPDATED) %>%
  left_join(vbr_biospecimens %>% select(ParticipantExternalID:SampleAvailability) %>% distinct(), 
            by = "ContainerID", na_matches = "never")
```

Generate table of UPDATED descriptors to upload to dewrangle
```{r}
vbr_dewrangle_update_input <- htp_dewrangle_specimens %>% 
  left_join(vbr_biospecimens_updated %>% select(sample_global_UPDATED, SampleID) %>% distinct(),
            by = c("global_id" = "sample_global_UPDATED")) %>% 
  filter(descriptor != SampleID) %>% 
  rename(descriptor_OLD = descriptor) %>% 
  select(descriptor = SampleID, fhir_resource_type, global_id)

# 4132 Global IDs need updated descriptors

```

Generate set of samples that need NEW global IDs to upload to dewrangle
```{r}
vbr_dewrangle_new_specimens_input <- vbr_globals_updated %>% 
  filter(is.na(sample_global_UPDATED)) %>% 
  select(descriptor = SampleID) %>% 
  mutate(fhir_resource_type = "Specimen") %>% 
  distinct() 

#%>% length() #9227
```


Make sure none of the "NEW" samples are in the "UPDATED" set & vice-versa
```{r}
length(setdiff(vbr_dewrangle_update_input$descriptor, vbr_dewrangle_new_specimens$descriptor))
length(setdiff(vbr_dewrangle_new_specimens$descriptor, vbr_dewrangle_update_input$descriptor))

```

Check for dupes in all the files:
```{r}
vbr_dewrangle_new_specimens_input %>% get_dupes(descriptor)
vbr_dewrangle_update_input %>% get_dupes(global_id)
vbr_biospecimens_updated %>% get_dupes(ContainerID)
```


Compare to set of global IDs in portal dump:
```{r}
length(setdiff(vbr_dewrangle_new_specimens_input$descriptor, 
               portal_dump$`External Sample ID`)) #9227

length(setdiff(vbr_dewrangle_update_input$global_id, 
               portal_dump$`Sample ID`)) #0
```



```{r}
vbr_dewrangle_update_input %>% write_csv(here::here("output", "vbr_dewrangle_update_input.csv"))

```

============START HERE

8/22 Matt to send new biospecimen file without duplicate rows -> redo above checks and regenerate dewrangle input files

**TODO:** Get global IDs, add to final vbr_biospecimens version

**TODO:** Final changelog with v3 vs v4 External & Global IDs


##### HARMONIZATION

**TODO:** add Participant & Sample Global IDs

Harmonize Biospecimen

**TODO:** CLean up NULL vs N/A
REMOVE DUPLICATE ROWS

```{r}
vbr_biospecimens %>% 
  select(studyCode = StudyCode,
         participantExternalId = ParticipantExternalID,
         sampleExternalId = SampleID,
         sampleType = SampleType,
         ageAtBiospecimenCollection = AgeInDaysAtBiospecimenCollection,
         parentSampleExternalId = ParentSampleID,
         parentSampleType = ParentSampleType,
         collectionExternalId = CollectionID,
         collectionSampleType = CollectionSampleType,
         containerExternalId = ContainerID,
         volume = Volume,
         volumeUnit = VolumeUnit,
         laboratoryProcedure = LaboratoryProcedure,
         biospecimenStorage = BiospecimenStorage,
         sampleAvailability = SampleAvailability,
         containerAvailability = containerAvailability) %>% 
  mutate(participantGlobalId = "TBD",
         sampleGlobalId = "TBD",
         parentSampleGlobalId = "TBD",
         collectionGlobalId = "TBD") %>% 
  write_csv(here::here("output", "vbr_biospecimens_draft_2023-08-15.csv"))

```



## OLD WORK

<!-- ## Get Unique Sample Types for enums -->

<!-- ```{r} -->
<!-- unique(c(vbr_biospecimens$SampleType,  -->
<!--          vbr_biospecimens$ParentSampleType, -->
<!--          vbr_biospecimens$CollectionSampleType)) %>% sort() -->
<!-- ``` -->

<!-- ## FIGURING OUT OLD VS NEW SAMPLE IDs -->

<!-- Get sample ID suffixes from dewrangle -->

<!-- ```{r} -->
<!-- htp_dewrangle %>%  -->
<!--   pull(descriptor) %>%  -->
<!--   str_replace("HTP.{5,7}_", "") %>%  -->
<!--   unique() -->
<!-- ``` -->

<!-- Get sample ID suffixes from VBR export -->

<!-- ```{r} -->
<!-- vbr_biospecimens %>%  -->
<!--   pull(SampleID) %>%  -->
<!--   str_replace("HTP.{5,7}_", "") %>%  -->
<!--   unique() -->
<!-- ``` -->

<!-- Read in Matt's lists of missing/unmatched samples -->

<!-- PART 1: 72 samples with --, 6 with NA or "Damaged BC"  -->
<!-- ```{r} -->
<!-- missing_containers <- read_delim(synGet("syn52293384")$path, "\t") %>%  -->
<!--   left_join(htp_dewrangle %>% select(global_id, descriptor), -->
<!--             by = c("Sample_global_id" = "global_id")) -->
<!-- ``` -->

<!-- look in aliquot.csv -->

<!-- ```{r} -->
<!-- aliquotcsv <- read_csv(synGet("syn52293019")$path) -->

<!-- aliquotcsv %>% filter(`Sample ID` %in% missing_containers$descriptor) -->
<!-- # these are all the Plasmas with NA or Damaged, so not helpful -->
<!-- ``` -->

<!-- compare v1 (htp_sample.csv) to v3 (FV_S71B1672_htp_samples_AND_COLLECTIONS_with_KF_global_ids_updated_2023-06-09.csv) -->

<!-- ```{r} -->
<!-- v1_sample_manifest <- read_csv(synGet("syn52293022")$path) #5494 -->
<!-- v3_sample_manifest <- read_csv(synGet("syn51514604")$path) #6430 -->
<!-- ``` -->
<!-- 161 samples in v1 aliquots.csv were not in v3  -->
<!-- -> Eric said 891 rows were dropped from aliquots.csv because of this -->
<!-- Per Matt, these should probably be deleted anyway, but he will check -->
<!-- ```{r} -->
<!-- #setdiff(v3_sample_manifest$`Sample External ID`, v1_sample_manifest$`Sample ID`) #1097 -->

<!-- v1_v3_setdiff <- setdiff(v1_sample_manifest$`Sample ID`, v3_sample_manifest$`Sample External ID`) #161 -->

<!-- htp_sample_manifest_robert %>%  -->
<!--   filter(`Sample ID` %in% v1_v3_setdiff) %>%  -->
<!--   write_csv(here::here("output", "v1_v3_setdiff.csv")) # sent to Matt -->
<!-- ``` -->


<!-- Look in v3 sample manifest -->
<!-- ```{r} -->
<!-- v3_sample_manifest %>% filter(`Sample External ID` %in% missing_containers$descriptor) -->

<!-- ``` -->

<!-- Look in portal dump -->
<!-- ```{r} -->
<!-- portal_dump <- read_tsv(synGet("syn52290446")$path) -->

<!-- missing_containers_that_have_files <- portal_dump %>%  -->
<!--   filter(`External Sample ID` %in% missing_containers$descriptor) %>%  -->
<!--   filter(Files != "--") %>%  -->
<!--   pull(`External Sample ID`) %>% unique() %>% sort() -->

<!-- #21 samples that don't have containers but do have files -->
<!-- ``` -->

<!-- Look in the HTP sample manifest file (Robert/Adam) -->
<!-- ```{r} -->
<!-- htp_sample_manifest_robert <- read_csv(synGet("syn48250502")$path) -->

<!-- htp_sample_manifest_robert %>%  -->
<!--   filter(`Sample ID` %in% missing_containers$descriptor) %>%  -->
<!--   pull(`Sample ID`) %>% unique() %>% sort() -->
<!-- # only the 6 Plasmas match Sample ID in Robert's sheet, and they don't have container IDs here either -->

<!-- # now look for those samples in Parent Sample column -->
<!-- htp_sample_manifest_robert %>%  -->
<!--   filter(`Parent Sample ID` %in% missing_containers$descriptor) %>% -->
<!--   pull(`Parent Sample ID`) %>% unique() -->
<!-- # 57, correct number -->
<!-- # these only appear as Parents and not Samples --> "created"? -->

<!-- ``` -->
<!-- From VBR Agenda 2023-05-30 -->

<!-- MISSING SAMPLES -->
<!-- 15 HTP samples with RNAseq in Data Service but not in portal  -->
<!-- These might have been in a small pilot - are there FASTQ files? Also public on GEO * check with Christina -->
<!-- HTP0084A2_RNA_paxgene -->
<!-- HTP0085B2_RNA_paxgene -->
<!-- HTP0204A_RNA_paxgene -->
<!-- HTP0206B_RNA_paxgene -->
<!-- HTP0288B_RNA_paxgene -->
<!-- HTP0302B_RNA_paxgene -->
<!-- HTP0310A_RNA_paxgene -->
<!-- HTP0322B_RNA_paxgene -->
<!-- HTP0326A_RNA_paxgene -->
<!-- HTP0328A_RNA_paxgene -->
<!-- HTP0332A_RNA_paxgene -->
<!-- HTP0338B_RNA_paxgene -->
<!-- HTP0348A_RNA_paxgene -->
<!-- HTP0351A_RNA_paxgene -->
<!-- HTP0442A2_RNA_paxgene -->


<!-- ```{r} -->
<!-- missing_15_samples <- c("HTP0084A2_RNA_paxgene", "HTP0085B2_RNA_paxgene", "HTP0204A_RNA_paxgene", "HTP0206B_RNA_paxgene", "HTP0288B_RNA_paxgene", "HTP0302B_RNA_paxgene", "HTP0310A_RNA_paxgene", "HTP0322B_RNA_paxgene", "HTP0326A_RNA_paxgene", "HTP0328A_RNA_paxgene", "HTP0332A_RNA_paxgene", "HTP0338B_RNA_paxgene", "HTP0348A_RNA_paxgene", "HTP0351A_RNA_paxgene", "HTP0442A2_RNA_paxgene") -->

<!-- setdiff(missing_containers_that_have_files, missing_15_samples) -->
<!-- ``` -->

<!-- PART 2: MISMATCHED CONTAINER IDs -->

<!-- ```{r} -->
<!-- unmatched_containers <- read_delim(synGet("syn52293382")$path, "\t") %>%  -->
<!--   left_join(htp_dewrangle %>% select(global_id, descriptor), -->
<!--             by = c("Sample_global_id" = "global_id")) -->
<!-- ``` -->
























